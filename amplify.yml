version: 1
frontend:
  framework: nextjs
  platform: node
  phases:
    preBuild:
      commands:
        - 'echo "📦 Starting preBuild phase..."'
        - 'echo "📂 Current directory: $(pwd)"'
        - 'echo "📁 Directory contents:"'
        - ls -la
        - 'echo "🔍 Checking for package files:"'
        - ls -la package*.json || echo "No package files found"
        - 'echo "🔧 Node version: $(node --version)"'
        - 'echo "📋 NPM version: $(npm --version)"'
        - 'echo "📥 Installing dependencies with npm ci..."'
        - npm ci --verbose || (echo "⚠️ npm ci failed, falling back to npm install..." && npm install --verbose)
        - 'echo "✅ Dependencies installed successfully"'
        - 'echo "📊 Installed packages:"'
        - npm list --depth=0
    build:
      commands:
        - 'echo "🏗️ Starting build phase..."'
        - 'echo "📂 Current directory: $(pwd)"'
        - 'echo "🌍 Setting up environment variables..."'
        - 'echo "NEXT_PUBLIC_BASE_URL=$NEXT_PUBLIC_BASE_URL" >> .env.local'
        - 'echo "NEXT_PUBLIC_COGNITO_USER_POOL_ID=$NEXT_PUBLIC_COGNITO_USER_POOL_ID" >> .env.local'
        - 'echo "NEXT_PUBLIC_COGNITO_USER_CLIENT_ID=$NEXT_PUBLIC_COGNITO_USER_CLIENT_ID" >> .env.local'
        - 'echo "REMOTE_URL=$REMOTE_URL" >> .env.local'
        - 'echo "STREAM_URL=$STREAM_URL" >> .env.local'
        - 'echo "🔍 Debug - Environment variables created:"'
        - cat .env.local
        - 'echo "🚀 Starting Next.js build with verbose logging..."'
        - npm run build --verbose
        - 'echo "✅ Build completed successfully"'
        - 'echo "📦 Build output summary:"'
        - ls -la .next/
        - 'echo "📊 Build size analysis:"'
        - du -sh .next/*
        - npm run start

  artifacts:
    baseDirectory: .next
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
